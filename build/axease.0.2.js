_$.ax=function(){var e=this;return e.elements=[],e.addScreen=function(t){"string"==typeof t.screen&&(t.screen=_$.getScreen(t.screen)),t.sprites&&t.sprites.forEach(function(e){"string"==typeof e.spriteId&&(e.img=_$.img[e.spriteId]),e.width||(e.width=t.screen.canvas.width),e.height||(e.height=t.screen.canvas.width/e.img.naturalWidth*e.img.naturalHeight),e.dy||(e.dy=100/_$.fps)}),e.elements.push(t),_$.update(!0)},e.draw=function(){e.elements.forEach(function(e){e.draw&&(e.screen.context.clearRect(0,0,e.screen.canvas.width,e.screen.canvas.height),e.draw.forEach(function(e){e()}))})},e.update=function(){e.elements.forEach(function(t){if(t.draw=!1,_$.isElVisible(t.screen.canvas)){var a={canvas:t.screen.canvas,context:t.screen.context,top:_$.getElTop(t.screen.canvas),halfWidth:.5*t.screen.canvas.width,halfHeight:.5*t.screen.canvas.height};t.sprites.forEach(function(r){var n;if(r.scroll?(n=e.scrollAnimation(r,a),r.dither&&(r.targetY=n.y)):r.mouse?n=e.mouseAnimation(r,a):r.time&&(n=e.timeAnimation(r,a)),n&&r.hasOwnProperty("targetY"))if(r.hasOwnProperty("y")){var i=r.dy;r.targetY>r.y?r.y+i>r.targetY?r.y=r.targetY:r.y+=i:r.targetY<r.y&&(r.y-i<r.targetY?r.y=r.targetY:r.y-=i),r.targetY==r.y&&delete r.targetY,n.y=r.y}else r.y=n.y;n&&(t.draw||(t.draw=[]),t.draw.push(function(){t.screen.context.drawImage(e.currentFrame(r),n.x+a.halfWidth-r.width/2,n.y+a.halfHeight-r.height/2,r.width||r.img.naturalWidth,r.height||r.img.naturalHeight)}))})}})},e.currentFrame=function(e){if(!e.animation)return e.img;if(!e.animation.canvas){var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var a=t.getContext("2d");e.animation.canvas=t,e.animation.context=a,e.animation.hasOwnProperty("animationIndex")||(e.animation.animationIndex=0)}var r=e.animation;return r.length&&(r=e.animation[r.animationIndex]),r.hasOwnProperty("frame")||(r.frame=0,r.lastDraw=Date.now()),_$.time>r.lastDraw+r.duration&&(r.frame++,r.frame>=r.frames.length&&(r.frame=0),r.lastDraw=_$.time),e.animation.context.clearRect(0,0,e.width,e.height),e.animation.context.drawImage(e.img,r.frames[r.frame][0]*e.width,r.frames[r.frame][1]*e.height,e.width,e.height,0,0,e.width,e.height),e.animation.canvas},e.timeAnimation=function(e,t){var a=(t.canvas,t.context,t.halfWidth),r=t.halfHeight,n=e.time;if(x=0,n.hasOwnProperty("frame")||(n.frame=0,n.currentX=n.frames[n.frame][0]*a,n.currentY=n.frames[n.frame][1]*r,n.targetX=n.currentX,n.targetY=n.currentY),n.travelledX>=n.distanceX&&n.travelledY>=n.distanceY||n.currentX==n.targetX&&e.time.currentY>=n.targetY){n.frame++,n.travelledX=0,n.travelledY=0,n.frame>=n.frames.length&&(n.frame=0,n.pingpong||(n.currentX=n.frames[n.frame][0]*a,n.currentY=e.time.frames[n.frame][1]*r)),void 0!==n.frames[n.frame][2]&&e.animation&&(e.animation.animationIndex=n.frames[n.frame][2]);var i=n.frames[n.frame][0]*a,c=n.frames[n.frame][1]*r,s=i-n.currentX,o=c-n.currentY;n.distanceX=Math.abs(s),n.distanceY=Math.abs(o),n.dx=s/n.duration*.001,n.dy=o/n.duration*.001}var h=_$.dt*n.dx,m=_$.dt*n.dy;return n.currentX+=h,n.currentY+=m,n.travelledX+=Math.abs(h),n.travelledY+=Math.abs(m),{x:n.currentX,y:n.currentY}},e.mouseAnimation=function(e,t){},e.scrollAnimation=function(e,t){var a,r,n,i=t.canvas,c=(t.context,t.halfWidth),s=t.halfHeight,o=_$.scrollY+.5*_$.screenHeight-(t.top+.5*i.offsetHeight),h=0>o?"below":o>0?"above":"center";switch(h){case"below":a=e.scroll.center,r=e.scroll.below,n=-1;break;case"center":a=e.scroll.center,r=e.scroll.center,n=0;break;case"above":a=e.scroll.center,r=e.scroll.above,n=1}var m=_$.screenHeight/2,f=0;if(x=0,r.hasOwnProperty("y")){var d=(r.y-a.y)*s,l=n*(d/m);f=l*o+e.scroll.center.y*s}if(r.hasOwnProperty("x")){var d=(r.x-a.x)*c,l=n*d/m;x=l*o+e.scroll.center.x*c}return{x:x,y:f}},_$.addUpdate(e.update,e.draw),e}();